#!/bin/bash

#
# Usage:
#       
#

usage() {
    echo "Usage:"
    echo
    echo "$0 <VEORUN_BIN> <lib1.a> [<lib2.a> ...]"
    echo
    exit 1
}

option_end=0
LIBS=()
VEORUN=''
default_LDFLAGS="-no-proginf -pthread"
while [ $# -gt 0 ]; do
  option="$1"
  if [ $option_end -eq 0 ]; then
    case "$option" in
    '--')
      option_end=1
      ;;
    '-h' | '--help')
      usage
      ;;
    '-o')
      VEORUN="$2"
      shift
      ;;
    '-fopenmp' | -L* | -l* | -Wl,*)
      default_LDFLAGS="${default_LDFLAGS} ${option}"
      ;;
    *)
      LIBS=(${LIBS[@]} "$option")
      ;;
    esac
    shift
  else
    LIBS=(${LIBS[@]} "$option")
  fi
done
default_LDFLAGS="${default_LDFLAGS} -ldl"

if [ -z "$VEORUN" ]; then
  if [ ${#LIBS[@]} -lt 2 ]; then
    usage
  fi
  VEORUN="${LIBS[0]}"
  unset LIBS[0]
else
  if [ ${#LIBS[@]} -lt 1 ]; then
    usage
  fi
fi

NM=${NM:-nm}
CC=${CC:-/opt/nec/ve/bin/ncc}
CXX=${CXX:-/opt/nec/ve/bin/nc++}
CFLAGS=${CFLAGS:-}
LDFLAGS=${LDFLAGS:-${default_LDFLAGS}}

SRC_FILE=$(mktemp /tmp/veorunXXXXXXX.c)
OBJ_FILE=${SRC_FILE/.c/.o}
trap "rm -f $SRC_FILE $OBJ_FILE" EXIT

@libexecdir@/gen_veorun_static_symtable "${LIBS[@]}" > $SRC_FILE

$CC $CFLAGS -c $SRC_FILE -o $OBJ_FILE
$CXX $CFLAGS -o $VEORUN $OBJ_FILE "${LIBS[@]}" @libdir@/libveorun.a $LDFLAGS \
    && echo "created specific $VEORUN"
